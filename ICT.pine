//@version=6
indicator("ICT Market Structure – Core Engine v6 (Updated OB)", overlay=true)

// =============================
// 1. INPUTS
// =============================
// Độ dài nến trái/phải để xác định Swing High/Low
var int swingLen = input.int(3, "Swing Length (L/R Bars)", minval=1)
// Tỷ lệ phần trăm tối thiểu của thân nến so với toàn bộ phạm vi nến (râu đến râu)
var float minBodyPct = input.float(0.35, "Min Body % For Displacement", minval=0.01, maxval=1.0)


// =============================
// 2. SWING DETECTION
// =============================
// Sử dụng 'var' để giữ giá trị qua các thanh nến
var float lastSwingHigh = na
var float lastSwingLow  = na

// ta.pivothigh trả về 'high' của nến đỉnh, nếu không thì là 'na'
float ph = ta.pivothigh(high, swingLen, swingLen)
// ta.pivotlow trả về 'low' của nến đáy, nếu không thì là 'na'
float pl = ta.pivotlow(low, swingLen, swingLen)

// Cập nhật Swing High mới nhất
if not na(ph)
    lastSwingHigh := ph

// Cập nhật Swing Low mới nhất
if not na(pl)
    lastSwingLow := pl

// Lấy chỉ số nến (bar_index) của swing gần nhất
int swingHighIdx = ta.valuewhen(not na(ph), bar_index, 0)
int swingLowIdx = ta.valuewhen(not na(pl), bar_index, 0)

// --- Vẽ các Swing (Tùy chọn) ---
plot(lastSwingHigh, title="Last Swing High", color=color.new(color.red, 50), style=plot.style_stepline, editable=false)
plot(lastSwingLow, title="Last Swing Low", color=color.new(color.green, 50), style=plot.style_stepline, editable=false)


// =============================
// 3. BOS DETECTION (Break of Structure)
// =============================
// BOS xảy ra khi giá đóng cửa (Close) phá vỡ Swing High/Low gần nhất.
bool bullBOS = close > lastSwingHigh and bar_index > swingHighIdx
bool bearBOS = close < lastSwingLow and bar_index > swingLowIdx


// =============================
// 4. DISPLACEMENT
// =============================
float body = math.abs(close - open)
// Đã sửa lỗi: 'range' đổi thành 'candleRange'
float candleRange = high - low
// Kiểm tra thân nến chiếm bao nhiêu phần trăm của tổng phạm vi
bool isDisplacement = candleRange > 0 and (body / candleRange) > minBodyPct


// =============================
// 5. MSS (Shift In Market Structure)
// =============================
// Theo dõi xu hướng hiện tại dựa trên BOS/MSS cuối cùng
var string currentTrend = "Ranging"
currentTrend := switch
    bullBOS => "Bullish"
    bearBOS => "Bearish"
    => currentTrend

// MSS xảy ra khi xu hướng bị phá vỡ theo hướng ngược lại với Displacement
bool bullMSS = currentTrend == "Bearish" and bullBOS and isDisplacement
bool bearMSS = currentTrend == "Bullish" and bearBOS and isDisplacement

// Cập nhật xu hướng sau khi MSS xảy ra
if bullMSS
    currentTrend := "Bullish"
else if bearMSS
    currentTrend := "Bearish"


// =============================
// 6. FVG (3 Candle ICT)
// =============================
// FVG xảy ra giữa C1 (2 nến trước) và C3 (nến hiện tại).
bool bullFVG = low > high[2]
bool bearFVG = high < low[2]

// --- Vẽ FVG (Tùy chọn) ---
if bullFVG
    line.new(bar_index - 2, high[2], bar_index, low, color=color.new(color.green, 70), style=line.style_dashed, width=1)
if bearFVG
    line.new(bar_index - 2, low[2], bar_index, high, color=color.new(color.red, 70), style=line.style_dashed, width=1)


// =============================
// 7. ORDER BLOCK (Sau MSS/BOS + Displacement) - ĐÃ CẬP NHẬT
// =============================

// Khởi tạo các biến 'var' để lưu thông tin Order Block đang hoạt động
var float bullOBHigh  = na
var float bullOBLow   = na
var float bearOBHigh  = na
var float bearOBLow   = na
var int   bullOBStartIdx = na
var int   bearOBStartIdx = na

// --- Logic xác định và lưu trữ OB ---

// 1. Bullish OB: Tìm nến giảm (Close < Open) cuối cùng trước cú phá vỡ/dịch chuyển tăng
if (bullBOS or bullMSS) and isDisplacement
    // Nến hiện tại là nến phá vỡ/dịch chuyển. Ta tìm nến OB trong quá khứ.
    for i = 1 to 10 // Lặp lại 10 thanh nến trước đó
        // Kiểm tra xem nến thứ i có phải là nến giảm (Bearish) không
        if close[i] < open[i]
            // Lưu lại thông tin OB
            bullOBHigh     := high[i]
            bullOBLow      := low[i]
            bullOBStartIdx := bar_index[i]
            // Xóa Bearish OB đang hoạt động nếu có sự đảo chiều mạnh
            bearOBHigh     := na
            bearOBLow      := na
            bearOBStartIdx := na
            break

// 2. Bearish OB: Tìm nến tăng (Close > Open) cuối cùng trước cú phá vỡ/dịch chuyển giảm
else if (bearBOS or bearMSS) and isDisplacement
    // Nến hiện tại là nến phá vỡ/dịch chuyển. Ta tìm nến OB trong quá khứ.
    for i = 1 to 10 // Lặp lại 10 thanh nến trước đó
        // Kiểm tra xem nến thứ i có phải là nến tăng (Bullish) không
        if close[i] > open[i]
            // Lưu lại thông tin OB
            bearOBHigh     := high[i]
            bearOBLow      := low[i]
            bearOBStartIdx := bar_index[i]
            // Xóa Bullish OB đang hoạt động nếu có sự đảo chiều mạnh
            bullOBHigh     := na
            bullOBLow      := na
            bullOBStartIdx := na
            break

// --- Logic vẽ và vô hiệu hóa OB ---

// Bullish OB
if not na(bullOBHigh)
    // Vẽ Box từ thanh nến OB đến thanh nến hiện tại
    box.new(bullOBStartIdx, bullOBHigh, bar_index, bullOBLow, 
         // Đã thay 'color' thành 'bgcolor'
         bgcolor=color.new(color.green, 85), 
         border_color=color.green, text="Bull OB", 
         text_halign=text.align_left)
        
// Bearish OB
if not na(bearOBHigh)
    // Vẽ Box từ thanh nến OB đến thanh nến hiện tại
    box.new(bearOBStartIdx, bearOBHigh, bar_index, bearOBLow, 
         // Đã thay 'color' thành 'bgcolor'
         bgcolor=color.new(color.red, 85), 
         border_color=color.red, text="Bear OB", 
         text_halign=text.align_left)

    // Nếu giá phá vỡ trên đỉnh OB, vô hiệu hóa OB này
    if high > bearOBHigh
        bearOBHigh     := na
        bearOBLow      := na
        bearOBStartIdx := na


// =============================
// 8. PLOT LABELS (ĐÃ CẢI THIỆN HIỂN THỊ VÀ SỬA LỖI TABLE)
// =============================

// --- 1. Nhãn BOS/MSS (Chỉ vẽ 1 lần trên thanh nến xác nhận) ---
// Ta dùng ta.cross để xác định nến phá vỡ chính xác hơn
bool isNewBullBOS = ta.cross(close, lastSwingHigh) and close > lastSwingHigh and bar_index > swingHighIdx
bool isNewBearBOS = ta.cross(close, lastSwingLow) and close < lastSwingLow and bar_index > swingLowIdx


// BOS Bullish (Không phải MSS)
if isNewBullBOS and not bullMSS
    label.new(bar_index, high, "BOS ↑", style=label.style_label_down, color=color.new(color.blue, 0), textcolor=color.white, yloc=yloc.abovebar)

// BOS Bearish (Không phải MSS)
if isNewBearBOS and not bearMSS
    label.new(bar_index, low, "BOS ↓", style=label.style_label_up, color=color.new(color.blue, 0), textcolor=color.white, yloc=yloc.belowbar)


// MSS Bullish
if bullMSS and isNewBullBOS
    label.new(bar_index, high, "MSS ↑", style=label.style_label_down, color=color.new(color.green, 0), textcolor=color.white, yloc=yloc.abovebar)

// MSS Bearish
if bearMSS and isNewBearBOS
    label.new(bar_index, low, "MSS ↓", style=label.style_label_up, color=color.new(color.red, 0), textcolor=color.white, yloc=yloc.belowbar)


// --- 2. Hiển thị Xu hướng Hiện tại (Dùng Bảng thay vì Nhãn trên mỗi nến) ---

// Tạo hoặc cập nhật bảng ở góc trên bên phải
// ĐÃ SỬA LỖI: Thay 'color' bằng 'bgcolor'
var table trendTable = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 90))

// Xác định màu sắc cho trạng thái
color trendColor = switch currentTrend
    "Bullish" => color.green
    "Bearish" => color.red
    => color.gray

// Cập nhật nội dung bảng
table.cell(trendTable, 0, 0, 
     text="TREND: " + currentTrend, 
     text_color=color.white, 
     bgcolor=trendColor, // Dùng bgcolor cho ô trong bảng
     width=10)
     
// Giữ lại plot na để tên chỉ báo xuất hiện đúng
plot(na, title="Current Trend", color=color.new(color.white, 100))
