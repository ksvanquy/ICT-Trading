//@version=5
indicator("ICT Multi-Timeframe Market Structure - Clean", "ICT-MTF-Clean", overlay=true, max_lines_count=100, max_boxes_count=50)

// =============================================================================
// INPUTS & SETTINGS
// =============================================================================

// Timeframe Settings
string tf1 = input.timeframe("15", "Lower Timeframe", group="Multi-Timeframe Settings")
string tf2 = input.timeframe("1H", "Higher Timeframe 1", group="Multi-Timeframe Settings")
string tf3 = input.timeframe("4H", "Higher Timeframe 2", group="Multi-Timeframe Settings")

// Structure Detection Settings
int swingLength = input.int(5, "Swing Detection Length", minval=3, maxval=20, group="Structure Settings")
bool showMSS = input.bool(true, "Show Market Structure Shift (MSS)", group="Structure Settings")
bool showBOS = input.bool(false, "Show Break of Structure (BOS)", group="Structure Settings")
bool showSwings = input.bool(false, "Show Swing Points", group="Structure Settings")

// Multi-Timeframe Display
bool showTF1 = input.bool(false, "Show Lower TF Structure", group="Display Settings")
bool showTF2 = input.bool(true, "Show Higher TF 1 Structure", group="Display Settings")
bool showTF3 = input.bool(true, "Show Higher TF 2 Structure", group="Display Settings")

// Visual Settings
color mssColorBull = input.color(color.new(color.green, 0), "MSS Bullish Color", group="Colors")
color mssColorBear = input.color(color.new(color.red, 0), "MSS Bearish Color", group="Colors")
color bosColorBull = input.color(color.new(color.blue, 20), "BOS Bullish Color", group="Colors")
color bosColorBear = input.color(color.new(color.orange, 20), "BOS Bearish Color", group="Colors")

bool showLines = input.bool(true, "Show MSS Lines", group="Visual Settings")
bool showLabels = input.bool(false, "Show MSS Labels", group="Visual Settings")
int lineLength = input.int(20, "Line Length (bars)", minval=5, maxval=100, group="Visual Settings")
bool showTable = input.bool(true, "Show Structure Table", group="Visual Settings")
bool compactMode = input.bool(true, "Compact Mode (Less Clutter)", group="Visual Settings")

// =============================================================================
// FUNCTIONS
// =============================================================================

// Swing Detection Function (Simplified)
swingDetection(length) =>
    ph = ta.pivothigh(high, length, length)
    pl = ta.pivotlow(low, length, length)
    
    var array<float> swingHighs = array.new<float>()
    var array<float> swingLows = array.new<float>()
    
    if not na(ph)
        array.push(swingHighs, ph)
        if array.size(swingHighs) > 5
            array.shift(swingHighs)
    
    if not na(pl)
        array.push(swingLows, pl)
        if array.size(swingLows) > 5
            array.shift(swingLows)
    
    [swingHighs, swingLows]

// Market Structure Analysis (Simplified)
marketStructure(swingHighs, swingLows) =>
    var int currentTrend = 0  // 1 bullish, -1 bearish, 0 neutral
    
    mssSignal = ""
    bosSignal = ""
    
    if array.size(swingHighs) >= 2 and array.size(swingLows) >= 2
        recentHigh = array.get(swingHighs, array.size(swingHighs) - 1)
        recentLow = array.get(swingLows, array.size(swingLows) - 1)
        
        // MSS Detection
        if close > recentHigh and currentTrend <= 0
            mssSignal := "MSS↑"
            currentTrend := 1
        else if close < recentLow and currentTrend >= 0
            mssSignal := "MSS↓"
            currentTrend := -1
        // BOS Detection  
        else if close > recentHigh and currentTrend > 0
            bosSignal := "BOS↑"
        else if close < recentLow and currentTrend < 0
            bosSignal := "BOS↓"
    
    [mssSignal, bosSignal, currentTrend]

// Timeframe Conversion
convertTimeframe(tf) =>
    switch tf
        "1H" => "60"
        "4H" => "240"
        "1D" => "1D"
        => tf

// Multi-Timeframe Structure (Simplified)
getMultiTimeframeStructure(tf) =>
    validTf = convertTimeframe(tf)
    htfClose = request.security(syminfo.tickerid, validTf, close, lookahead=barmerge.lookahead_off)
    
    var int htfTrend = 0
    var string htfMSS = ""
    
    // Simple trend detection
    if htfClose > htfClose[1] and htfTrend <= 0
        htfMSS := "MSS↑"
        htfTrend := 1
    else if htfClose < htfClose[1] and htfTrend >= 0
        htfMSS := "MSS↓"
        htfTrend := -1
    
    [htfMSS, htfTrend]

// =============================================================================
// MAIN CALCULATIONS
// =============================================================================

// Current timeframe structure
[currentSwingHighs, currentSwingLows] = swingDetection(swingLength)
[currentMSS, currentBOS, currentTrend] = marketStructure(currentSwingHighs, currentSwingLows)

// Multi-timeframe structure
var string tf2MSS = ""
var int tf2Trend = 0
var string tf3MSS = ""
var int tf3Trend = 0

if showTF2
    [tempMSS2, tempTrend2] = getMultiTimeframeStructure(tf2)
    tf2MSS := tempMSS2
    tf2Trend := tempTrend2

if showTF3
    [tempMSS3, tempTrend3] = getMultiTimeframeStructure(tf3)
    tf3MSS := tempMSS3
    tf3Trend := tempTrend3

// =============================================================================
// VISUALIZATIONS (CLEAN)
// =============================================================================

// Function to get label color
getLabelColor(signal) =>
    switch signal
        "MSS↑" => mssColorBull
        "MSS↓" => mssColorBear  
        "BOS↑" => bosColorBull
        "BOS↓" => bosColorBear
        => color.gray

// Line styles for different timeframes
// Current TF: Solid line
// TF2: Dashed line  
// TF3: Dotted line

// MSS Lines - Current Timeframe
var int lastMSSBar = 0
if showLines and showMSS and currentMSS != "" and bar_index > lastMSSBar + 10
    mssPrice = currentMSS == "MSS↑" ? high : low
    line.new(bar_index, mssPrice, bar_index + lineLength, mssPrice, 
             color=getLabelColor(currentMSS), 
             width=2, 
             style=line.style_solid)
    if showLabels
        label.new(bar_index + lineLength/2, mssPrice, currentMSS, 
                  color=color.new(getLabelColor(currentMSS), 80), 
                  textcolor=color.white, 
                  style=label.style_label_center,
                  size=size.small)
    lastMSSBar := bar_index

// MSS Lines - Higher Timeframes
var int lastTF2Bar = 0
var int lastTF3Bar = 0

if showLines and showTF2 and tf2MSS != "" and bar_index > lastTF2Bar + 20
    tf2Price = tf2MSS == "MSS↑" ? high * 1.002 : low * 0.998
    line.new(bar_index, tf2Price, bar_index + lineLength, tf2Price, 
             color=color.new(getLabelColor(tf2MSS), 30), 
             width=3, 
             style=line.style_dashed)
    if showLabels
        label.new(bar_index + lineLength/2, tf2Price, tf2MSS + "(" + tf2 + ")", 
                  color=color.new(getLabelColor(tf2MSS), 70), 
                  textcolor=color.white, 
                  style=label.style_label_center,
                  size=size.tiny)
    lastTF2Bar := bar_index

if showLines and showTF3 and tf3MSS != "" and bar_index > lastTF3Bar + 30
    tf3Price = tf3MSS == "MSS↑" ? high * 1.004 : low * 0.996
    line.new(bar_index, tf3Price, bar_index + lineLength, tf3Price, 
             color=getLabelColor(tf3MSS), 
             width=4, 
             style=line.style_dotted)
    if showLabels
        label.new(bar_index + lineLength/2, tf3Price, tf3MSS + "(" + tf3 + ")", 
                  color=getLabelColor(tf3MSS), 
                  textcolor=color.white, 
                  style=label.style_label_center,
                  size=size.small)
    lastTF3Bar := bar_index

// BOS Lines (Optional)
var int lastBOSBar = 0
if showLines and showBOS and currentBOS != "" and bar_index > lastBOSBar + 5
    bosPrice = currentBOS == "BOS↑" ? high * 1.001 : low * 0.999
    line.new(bar_index, bosPrice, bar_index + lineLength/2, bosPrice, 
             color=color.new(getLabelColor(currentBOS), 40), 
             width=1, 
             style=line.style_solid)
    lastBOSBar := bar_index

// Swing Points (Optional)
showSwingHigh = false
showSwingLow = false

if showSwings and array.size(currentSwingHighs) > 0
    recentHigh = array.get(currentSwingHighs, array.size(currentSwingHighs) - 1)
    if high == recentHigh
        showSwingHigh := true

if showSwings and array.size(currentSwingLows) > 0
    recentLow = array.get(currentSwingLows, array.size(currentSwingLows) - 1)
    if low == recentLow
        showSwingLow := true

plotshape(showSwingHigh, "Swing High", shape.triangledown, location.abovebar, color.new(color.red, 50), size=size.tiny)
plotshape(showSwingLow, "Swing Low", shape.triangleup, location.belowbar, color.new(color.green, 50), size=size.tiny)

// =============================================================================
// COMPACT TABLE
// =============================================================================

var table structureTable = na
if showTable
    structureTable := table.new(position.top_right, 3, 4, bgcolor=color.new(color.white, 90), border_width=1)

if barstate.islast and showTable
    // Headers
    table.cell(structureTable, 0, 0, "TF", text_color=color.black, text_size=size.tiny, bgcolor=color.new(color.gray, 70))
    table.cell(structureTable, 1, 0, "MSS", text_color=color.black, text_size=size.tiny, bgcolor=color.new(color.gray, 70))
    table.cell(structureTable, 2, 0, "Trend", text_color=color.black, text_size=size.tiny, bgcolor=color.new(color.gray, 70))
    
    // Current
    currentStructure = currentMSS != "" ? currentMSS : "-"
    currentTrendSymbol = currentTrend > 0 ? "↑" : (currentTrend < 0 ? "↓" : "-")
    table.cell(structureTable, 0, 1, str.tostring(timeframe.period), text_color=color.black, text_size=size.tiny)
    table.cell(structureTable, 1, 1, currentStructure, text_color=currentTrend > 0 ? color.green : (currentTrend < 0 ? color.red : color.gray), text_size=size.tiny)
    table.cell(structureTable, 2, 1, currentTrendSymbol, text_color=currentTrend > 0 ? color.green : (currentTrend < 0 ? color.red : color.gray), text_size=size.tiny)
    
    // TF2
    if showTF2
        tf2Structure = tf2MSS != "" ? tf2MSS : "-"
        tf2TrendSymbol = tf2Trend > 0 ? "↑" : (tf2Trend < 0 ? "↓" : "-")
        table.cell(structureTable, 0, 2, tf2, text_color=color.black, text_size=size.tiny)
        table.cell(structureTable, 1, 2, tf2Structure, text_color=tf2Trend > 0 ? color.green : (tf2Trend < 0 ? color.red : color.gray), text_size=size.tiny)
        table.cell(structureTable, 2, 2, tf2TrendSymbol, text_color=tf2Trend > 0 ? color.green : (tf2Trend < 0 ? color.red : color.gray), text_size=size.tiny)
    
    // TF3
    if showTF3
        tf3Structure = tf3MSS != "" ? tf3MSS : "-"
        tf3TrendSymbol = tf3Trend > 0 ? "↑" : (tf3Trend < 0 ? "↓" : "-")
        table.cell(structureTable, 0, 3, tf3, text_color=color.black, text_size=size.tiny)
        table.cell(structureTable, 1, 3, tf3Structure, text_color=tf3Trend > 0 ? color.green : (tf3Trend < 0 ? color.red : color.gray), text_size=size.tiny)
        table.cell(structureTable, 2, 3, tf3TrendSymbol, text_color=tf3Trend > 0 ? color.green : (tf3Trend < 0 ? color.red : color.gray), text_size=size.tiny)

// =============================================================================
// ALERTS (SIMPLIFIED)
// =============================================================================

// Only MSS Alerts
alertcondition(currentMSS == "MSS↑", "MSS Bullish", "Market Structure Shift Bullish: {{ticker}} {{interval}}")
alertcondition(currentMSS == "MSS↓", "MSS Bearish", "Market Structure Shift Bearish: {{ticker}} {{interval}}")

// Multi-timeframe confluence
alertcondition(currentMSS == "MSS↑" and tf2Trend > 0 and tf3Trend > 0, "MTF Bullish Alignment", "Multi-Timeframe Bullish Alignment: {{ticker}}")
alertcondition(currentMSS == "MSS↓" and tf2Trend < 0 and tf3Trend < 0, "MTF Bearish Alignment", "Multi-Timeframe Bearish Alignment: {{ticker}}")

// =============================================================================
// PLOTS (MINIMAL)
// =============================================================================

// Essential plots only
plot(currentTrend, "Current Trend", display=display.data_window, color=color.new(color.blue, 100))
plot(currentMSS == "MSS↑" ? 1 : currentMSS == "MSS↓" ? -1 : 0, "MSS Signal", display=display.data_window, color=color.new(color.green, 100))