//@version=6
indicator("ICT Market Structure Core Engine v6 (Updated OB - Fixed Box) - S·ª≠a l·ªói MSS", overlay=true)

// =============================
// 1. INPUTS
// =============================
var int swingLen = input.int(3, "Swing Length (L/R Bars)", minval=1)
var float minBodyPct = input.float(0.35, "Min Body % For Displacement", minval=0.01, maxval=1.0)
var bool deleteOB = input.bool(false, "Delete Previous OB on New BOS/MSS (Show only active OB)")
var int obLookback = input.int(10, "OB Lookback Bars", minval=1, maxval=50)


// =============================
// 2. SWING DETECTION
// =============================
// L∆∞u Swing High/Low g·∫ßn nh·∫•t
var float lastSwingHigh = na
var float lastSwingLow = na
var int swingHighIdx = na
var int swingLowIdx = na

float ph = ta.pivothigh(high, swingLen, swingLen)
float pl = ta.pivotlow(low, swingLen, swingLen)

if not na(ph)
    lastSwingHigh := ph
    swingHighIdx := bar_index - swingLen
    
if not na(pl)
    lastSwingLow := pl
    swingLowIdx := bar_index - swingLen

// --- V·∫Ω c√°c Swing (T√πy ch·ªçn) ---
plot(lastSwingHigh, title="Last Swing High", color=color.new(color.red, 50), style=plot.style_stepline, editable=false)
plot(lastSwingLow, title="Last Swing Low", color=color.new(color.green, 50), style=plot.style_stepline, editable=false)


// =============================
// 3. DISPLACEMENT & BOS/MSS DETECTION üéØ
// =============================
float body = math.abs(close - open)
float candleRange = high - low
bool isDisplacement = candleRange > 0 and (body / candleRange) > minBodyPct

// --- Logic Ph√° v·ª° (Break) ---
bool bullBreak = close > lastSwingHigh[1] and bar_index > swingHighIdx[1] // Ph√° v·ª° m·ª©c High c≈©
bool bearBreak = close < lastSwingLow[1] and bar_index > swingLowIdx[1] // Ph√° v·ª° m·ª©c Low c≈©

// --- Logic Xu h∆∞·ªõng v√† MSS/BOS ---
var string currentTrend = "Ranging"
var string lastEvent = "None" // L∆∞u l·∫°i s·ª± ki·ªán BOS/MSS cu·ªëi c√πng

// 1. X√°c ƒë·ªãnh s·ª± ki·ªán ph√° v·ª° m·ªõi (Ch·ªâ x·∫£y ra tr√™n n·∫øn hi·ªán t·∫°i)
bool isNewBullBreak = ta.cross(close, lastSwingHigh[1]) and close > lastSwingHigh[1] and bar_index > swingHighIdx[1]
bool isNewBearBreak = ta.cross(close, lastSwingLow[1]) and close < lastSwingLow[1] and bar_index > swingLowIdx[1]

// 2. Ph√¢n lo·∫°i BOS v√† MSS
bool isNewBullBOS = false
bool isNewBearBOS = false
bool isNewBullMSS = false
bool isNewBearMSS = false

if isNewBullBreak
    // N·∫øu xu h∆∞·ªõng l√† TƒÉng (ho·∫∑c Ranging) -> ƒê√¢y l√† BOS ti·∫øp di·ªÖn (ho·∫∑c b·∫Øt ƒë·∫ßu xu h∆∞·ªõng)
    if currentTrend == "Bullish" or currentTrend == "Ranging"
        isNewBullBOS := true
        currentTrend := "Bullish"
        lastEvent := "BOS"
    // N·∫øu xu h∆∞·ªõng l√† Gi·∫£m -> ƒê√¢y l√† MSS ƒë·∫£o chi·ªÅu (C·∫¶N DISPLACEMENT)
    else if currentTrend == "Bearish" and isDisplacement
        isNewBullMSS := true
        currentTrend := "Bullish" // ƒê·∫£o chi·ªÅu xu h∆∞·ªõng
        lastEvent := "MSS"

if isNewBearBreak
    // N·∫øu xu h∆∞·ªõng l√† Gi·∫£m (ho·∫∑c Ranging) -> ƒê√¢y l√† BOS ti·∫øp di·ªÖn (ho·∫∑c b·∫Øt ƒë·∫ßu xu h∆∞·ªõng)
    if currentTrend == "Bearish" or currentTrend == "Ranging"
        isNewBearBOS := true
        currentTrend := "Bearish"
        lastEvent := "BOS"
    // N·∫øu xu h∆∞·ªõng l√† TƒÉng -> ƒê√¢y l√† MSS ƒë·∫£o chi·ªÅu (C·∫¶N DISPLACEMENT)
    else if currentTrend == "Bullish" and isDisplacement
        isNewBearMSS := true
        currentTrend := "Bearish" // ƒê·∫£o chi·ªÅu xu h∆∞·ªõng
        lastEvent := "MSS"


// =============================
// 6. FVG (3 Candle ICT)
// =============================
bool bullFVG = low > high[2]
bool bearFVG = high < low[2]

// --- V·∫Ω FVG (T√πy ch·ªçn) ---
// if bullFVG
//     line.new(bar_index - 2, high[2], bar_index, low, color=color.new(color.green, 70), style=line.style_dashed, width=1)
// if bearFVG
//     line.new(bar_index - 2, low[2], bar_index, high, color=color.new(color.red, 70), style=line.style_dashed, width=1)


// =============================
// 7. ORDER BLOCK (Sau MSS/BOS + Displacement)
// =============================

// Kh·ªüi t·∫°o c√°c bi·∫øn 'var' ƒë·ªÉ l∆∞u th√¥ng tin Order Block ƒëang ho·∫°t ƒë·ªông
var float bullOBHigh = na
var float bullOBLow = na
var int bullOBStartIdx = na
var box bullOBBox = na

var float bearOBHigh = na
var float bearOBLow = na
var int bearOBStartIdx = na
var box bearOBBox = na


// --- Logic x√°c ƒë·ªãnh v√† l∆∞u tr·ªØ OB ---

// 1. Bullish OB: T√¨m n·∫øn gi·∫£m cu·ªëi c√πng tr∆∞·ªõc c√∫ ph√° v·ª°/d·ªãch chuy·ªÉn tƒÉng
if (isNewBullBOS or isNewBullMSS) and isDisplacement
    // X√≥a OB c≈© n·∫øu ch·ªçn ho·∫∑c n·∫øu c√≥ s·ª± ki·ªán ƒë·∫£o chi·ªÅu (Bearish -> Bullish)
    if deleteOB or isNewBullMSS
        box.delete(bearOBBox)
        bearOBBox := na
        bearOBHigh := na
        bearOBLow := na
        
    // X√≥a OB Bullish c≈© n·∫øu ch·ªçn, sau ƒë√≥ t·∫°o OB m·ªõi
    if deleteOB or isNewBullBOS
        box.delete(bullOBBox)
        bullOBBox := na
        bullOBHigh := na
        bullOBLow := na

    for i = 1 to obLookback
        if close[i] < open[i] // T√¨m n·∫øn gi·∫£m (Down Close Candle)
            bullOBHigh := high[i]
            bullOBLow := low[i]
            bullOBStartIdx := bar_index[i]
            
            bullOBBox := box.new(bullOBStartIdx, bullOBHigh, bar_index, bullOBLow, 
                             bgcolor=color.new(color.green, 85), 
                             border_color=color.new(color.green, 50), 
                             text="Bull OB", 
                             text_color=color.new(color.white, 75), 
                             text_halign=text.align_left)
            break

// 2. Bearish OB: T√¨m n·∫øn tƒÉng cu·ªëi c√πng tr∆∞·ªõc c√∫ ph√° v·ª°/d·ªãch chuy·ªÉn gi·∫£m
else if (isNewBearBOS or isNewBearMSS) and isDisplacement
    // X√≥a OB c≈© n·∫øu ch·ªçn ho·∫∑c n·∫øu c√≥ s·ª± ki·ªán ƒë·∫£o chi·ªÅu (Bullish -> Bearish)
    if deleteOB or isNewBearMSS
        box.delete(bullOBBox)
        bullOBBox := na
        bullOBHigh := na
        bullOBLow := na
        
    // X√≥a OB Bearish c≈© n·∫øu ch·ªçn, sau ƒë√≥ t·∫°o OB m·ªõi
    if deleteOB or isNewBearBOS
        box.delete(bearOBBox)
        bearOBBox := na
        bearOBHigh := na
        bearOBLow := na

    for i = 1 to obLookback
        if close[i] > open[i] // T√¨m n·∫øn tƒÉng (Up Close Candle)
            bearOBHigh := high[i]
            bearOBLow := low[i]
            bearOBStartIdx := bar_index[i]
            
            bearOBBox := box.new(bearOBStartIdx, bearOBHigh, bar_index, bearOBLow, 
                             bgcolor=color.new(color.red, 85), 
                             border_color=color.new(color.red, 50), 
                             text="Bear OB", 
                             text_color=color.new(color.white, 75), 
                             text_halign=text.align_left)
            break


// --- Logic c·∫≠p nh·∫≠t v√† v√¥ hi·ªáu h√≥a OB ---

// 1. C·∫≠p nh·∫≠t v√† V√¥ hi·ªáu h√≥a Bullish OB
if not na(bullOBBox)
    box.set_right(bullOBBox, bar_index)
    if low < bullOBLow // B·ªã ph√° v·ª° ƒë√°y OB
        box.delete(bullOBBox)
        bullOBBox := na 
        bullOBHigh := na
        bullOBLow := na


// 2. C·∫≠p nh·∫≠t v√† V√¥ hi·ªáu h√≥a Bearish OB
if not na(bearOBBox)
    box.set_right(bearOBBox, bar_index)
    if high > bearOBHigh // B·ªã ph√° v·ª° ƒë·ªânh OB
        box.delete(bearOBBox)
        bearOBBox := na 
        bearOBHigh := na
        bearOBLow := na


// =============================
// 8. PLOT LABELS (BOS/MSS) üé®
// =============================
// Bi·∫øn l∆∞u tr·ªØ ID c·ªßa ƒë∆∞·ªùng k·∫ª BOS/MSS
var line bullBOS_line_id = na
var line bearBOS_line_id = na
var label bullBOS_label_id = na
var label bearBOS_label_id = na

// 1. X·ª≠ l√Ω v√† V·∫Ω BOS/MSS Bullish
if isNewBullBOS or isNewBullMSS
    // X√≥a ƒë·ªëi t∆∞·ª£ng c≈©
    line.delete(bullBOS_line_id)
    label.delete(bullBOS_label_id)
    line.delete(bearBOS_line_id)
    label.delete(bearBOS_label_id)
    bearBOS_line_id := na
    bearBOS_label_id := na
    
    // X√°c ƒë·ªãnh nh√£n v√† m√†u
    string bos_text = isNewBullMSS ? "MSS ‚Üë" : "BOS ‚Üë"
    color bos_color = isNewBullMSS ? color.green : color.blue
    float broken_level = lastSwingHigh[1]
    int start_idx = swingHighIdx[1]
    
    // V·∫º ƒê∆Ø·ªúNG NGANG
    bullBOS_line_id := line.new(start_idx, broken_level, bar_index, broken_level, 
                             color=color.new(bos_color, 30), style=line.style_dotted, width=1, extend=extend.none)
    // V·∫º NH√ÉN
    bullBOS_label_id := label.new(start_idx, broken_level, bos_text, 
                             style=label.style_label_down, color=color.new(bos_color, 0), textcolor=color.white, yloc=yloc.price)

// 2. X·ª≠ l√Ω v√† V·∫Ω BOS/MSS Bearish
else if isNewBearBOS or isNewBearMSS
    // X√≥a ƒë·ªëi t∆∞·ª£ng c≈©
    line.delete(bearBOS_line_id)
    label.delete(bearBOS_label_id)
    line.delete(bullBOS_line_id)
    label.delete(bullBOS_label_id)
    bullBOS_line_id := na
    bullBOS_label_id := na

    // X√°c ƒë·ªãnh nh√£n v√† m√†u
    string bos_text = isNewBearMSS ? "MSS ‚Üì" : "BOS ‚Üì"
    color bos_color = isNewBearMSS ? color.red : color.blue
    float broken_level = lastSwingLow[1]
    int start_idx = swingLowIdx[1]

    // V·∫º ƒê∆Ø·ªúNG NGANG
    bearBOS_line_id := line.new(start_idx, broken_level, bar_index, broken_level, 
                             color=color.new(bos_color, 30), style=line.style_dotted, width=1, extend=extend.none)
    // V·∫º NH√ÉN
    bearBOS_label_id := label.new(start_idx, broken_level, bos_text, 
                             style=label.style_label_up, color=color.new(bos_color, 0), textcolor=color.white, yloc=yloc.price)

// C·∫≠p nh·∫≠t v·ªã tr√≠ cu·ªëi c√πng c·ªßa ƒë∆∞·ªùng k·∫ª BOS/MSS
if not na(bullBOS_line_id)
    line.set_x2(bullBOS_line_id, bar_index)
if not na(bearBOS_line_id)
    line.set_x2(bearBOS_line_id, bar_index)


// =============================
// 9. TRADE SETUP LOGIC (Ph·∫ßn B·ªï Sung) üéØ
// =============================

// C√°c bi·∫øn l∆∞u tr·ªØ Setup
var float setupEntry = na
var float setupSL = na
var float setupTP = na // NEW: Bi·∫øn l∆∞u Take Profit
var string setupType = "None" // "Buy" / "Sell"
// Bi·∫øn l∆∞u tr·ªØ s·ª± ki·ªán k√≠ch ho·∫°t Setup (BOS/MSS)
var string setupReason = "None"

// --- 1. SETUP MUA (BUY) ---
// K√≠ch ho·∫°t Setup Buy khi c√≥ BOS/MSS Bullish M·ªöI v√† c√≥ OB ƒëang ho·∫°t ƒë·ªông
if (isNewBullBOS or isNewBullMSS) and not na(bullOBBox)
    setupEntry := bullOBHigh
    setupSL := bullOBLow
    setupType := "Buy"
    setupReason := isNewBullMSS ? "MSS" : "BOS"
    
    // T√çNH TO√ÅN R:R 1:2
    float risk = bullOBHigh - bullOBLow
    setupTP := bullOBHigh + (risk * 2)

// --- 2. SETUP B√ÅN (SELL) ---
// K√≠ch ho·∫°t Setup Sell khi c√≥ BOS/MSS Bearish M·ªöI v√† c√≥ OB ƒëang ho·∫°t ƒë·ªông
else if (isNewBearBOS or isNewBearMSS) and not na(bearOBBox)
    setupEntry := bearOBLow
    setupSL := bearOBHigh
    setupType := "Sell"
    setupReason := isNewBearMSS ? "MSS" : "BOS"

    // T√çNH TO√ÅN R:R 1:2
    float risk = bearOBHigh - bearOBLow
    setupTP := bearOBLow - (risk * 2)

// --- 3. V√¥ hi·ªáu h√≥a Setup khi gi√° ph√° v·ª° SL ho·∫∑c OB b·ªã v√¥ hi·ªáu h√≥a ---
if setupType == "Buy" and (low < setupSL or na(bullOBBox)) // N·∫øu gi√° ph√° SL ho·∫∑c OB b·ªã v√¥ hi·ªáu h√≥a
    setupType := "None"
    setupEntry := na
    setupSL := na
    setupTP := na // Reset TP
    setupReason := "None"
else if setupType == "Sell" and (high > setupSL or na(bearOBBox)) // N·∫øu gi√° ph√° SL ho·∫∑c OB b·ªã v√¥ hi·ªáu h√≥a
    setupType := "None"
    setupEntry := na
    setupSL := na
    setupTP := na // Reset TP
    setupReason := "None"


// =============================
// 10. PLOT TRADE SETUP & TABLE
// =============================

// Bi·∫øn l∆∞u ID line
var line entryLineID = na
var line slLineID = na
var line tpLineID = na // NEW: ID Line TP
var label entryLabelID = na
var label slLabelID = na
var label tpLabelID = na // NEW: ID Label TP

// X√≥a Setup c≈©
line.delete(entryLineID)
line.delete(slLineID)
line.delete(tpLineID) // X√≥a TP c≈©
label.delete(entryLabelID)
label.delete(slLabelID)
label.delete(tpLabelID) // X√≥a Label TP c≈©


// V·∫Ω Setup m·ªõi (K√©o d√†i ƒë·∫øn t∆∞∆°ng lai)
if setupType == "Buy"
    setupColor = color.green
    int start_idx = bullOBStartIdx
    
    // V·∫Ω Entry (K√©o d√†i t·ª´ OBStartIdx)
    entryLineID := line.new(start_idx, setupEntry, bar_index + 5, setupEntry, color=color.new(setupColor, 10), style=line.style_solid, width=2, extend=extend.right)
    entryLabelID := label.new(bar_index, setupEntry, "ENTRY", 
                             color=color.new(setupColor, 0), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)
    
    // V·∫Ω Stop Loss (SL)
    slLineID := line.new(start_idx, setupSL, bar_index + 5, setupSL, 
                             color=color.new(setupColor, 50), style=line.style_dotted, width=1, extend=extend.right)
    slLabelID := label.new(bar_index, setupSL, "SL", color=color.new(setupColor, 50), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)

    // NEW: V·∫Ω Take Profit (TP - R:R 1:2)
    tpLineID := line.new(start_idx, setupTP, bar_index + 5, setupTP, 
                             color=color.new(setupColor, 10), style=line.style_dotted, width=2, extend=extend.right)
    tpLabelID := label.new(bar_index, setupTP, "TP 1:2", color=color.new(setupColor, 0), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)


else if setupType == "Sell"
    setupColor = color.red
    int start_idx = bearOBStartIdx

    // V·∫Ω Entry (K√©o d√†i t·ª´ OBStartIdx)
    entryLineID := line.new(start_idx, setupEntry, bar_index + 5, setupEntry, color=color.new(setupColor, 10), style=line.style_solid, width=2, extend=extend.right)
    entryLabelID := label.new(bar_index, setupEntry, "ENTRY", color=color.new(setupColor, 0), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)
    
    // V·∫Ω Stop Loss (SL)
    slLineID := line.new(start_idx, setupSL, bar_index + 5, setupSL,color=color.new(setupColor, 50), style=line.style_dotted, width=1, extend=extend.right)
    slLabelID := label.new(bar_index, setupSL, "SL", color=color.new(setupColor, 50), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)

    // NEW: V·∫Ω Take Profit (TP - R:R 1:2)
    tpLineID := line.new(start_idx, setupTP, bar_index + 5, setupTP, 
                             color=color.new(setupColor, 10), style=line.style_dotted, width=2, extend=extend.right)
    tpLabelID := label.new(bar_index, setupTP, "TP 1:2", color=color.new(setupColor, 0), textcolor=color.white, style=label.style_label_left, yloc=yloc.price)


// --- Hi·ªÉn th·ªã Setup tr√™n B·∫£ng (C·∫≠p nh·∫≠t B·∫£ng Trend) ---
var table trendTable = table.new(position.top_right, 1, 1, bgcolor=color.new(color.black, 90))

color trendColor = switch currentTrend
    "Bullish" => color.green
    "Bearish" => color.red
    => color.gray

color trendColorUpdated = switch setupType
    "Buy" => color.green
    "Sell" => color.red
    => trendColor

string reasonText = setupType != "None" ? "REASON: " + setupReason : ""

// C·∫≠p nh·∫≠t chu·ªói setup ƒë·ªÉ hi·ªÉn th·ªã TP
string setupText = switch setupType
    "Buy" => "SETUP: BUY @ " + str.tostring(setupEntry, format.mintick) + " (SL: " + str.tostring(setupSL, format.mintick) + ")"
    "Sell" => "SETUP: SELL @ " + str.tostring(setupEntry, format.mintick) + " (SL: " + str.tostring(setupSL, format.mintick) + ")"
    => "SETUP: NONE"

// NEW: Chu·ªói TP
string tpText = setupType != "None" ? "TP 1:2 @ " + str.tostring(setupTP, format.mintick) : ""

// C·∫≠p nh·∫≠t chu·ªói hi·ªÉn th·ªã ch√≠nh
string mainText = "TREND: " + currentTrend + "\n" + setupText + (setupType != "None" ? "\n" + tpText + "\n" + reasonText : "")

// TƒÉng width l√™n 20 v√† c·∫≠p nh·∫≠t text
table.cell(trendTable, 0, 0, text=mainText, text_color=color.white, bgcolor=trendColorUpdated, width=20)
